/*! Built 13-10-2013 at #SWPNS */
!function(){function a(){this.ox=this.attr("x"),this.oy=this.attr("y")}function b(a,b){var c=this.ox+a,d=this.oy+b;c=Math.min(s-this.attr("width")-10,c),c=Math.max(10,c),d=Math.min(r-this.attr("height")-10,d),d=Math.max(10,d),this.attr({x:c,y:d}),this._moving=!0,this._glow&&(this._glow.remove(),this._glow=void 0)}function c(){d(this,this.selected)}function d(a,b){a._glow&&a._glow.remove(),a._glow=a.glow({color:b?"#21a3c9":"#000000"})}function e(a){a&&(a.selected=!1,d(a,!1),y=null)}function f(a){a.selected=!0,d(a,!0),y=a}function g(a){var b=y._index,c=x.splice(a?b+1:b-1,1)[0];y._index=a?y._index+1:y._index-1,c._index=a?c._index-1:c._index+1,y[a?"insertAfter":"insertBefore"](c),x.splice(c._index,0,c),d(y,y.selected)}function h(a){a.preventDefault(),x.length<2||!y||0===y._index||g(!1)}function i(){event.preventDefault(),x.length<2||!y||y._index===x.length-1||g(!0)}function j(d){d._index=x.length,d.click(function(a){a.stopPropagation(),this!==y||this._moving||e(this),this._moving&&(this._moving=!1)}),d.dblclick(function(a){a.stopPropagation(),e(y),f(this)}),d._glow=d.glow(),d.drag(b,a,c),x.push(d)}function k(a){var b=t.rect(200,200,a.width,a.height);b.attr({cursor:"move",stroke:"#FFF","stroke-width":10,fill:"url("+a.url+")"}),b._type="image",b._width=a.width,b._height=a.height,b._url=a.url,j(b)}function l(a){var b,c={board:o},d=0,e=[];for(a.preventDefault();b=x[d++];)e.push({type:b._type,x:b.attr("x"),y:b.attr("y"),width:b._width||null,height:b._height||null,url:b._url||null,index:b._index,hex:b._hex||null});c.elements=e,$.ajax({url:"/api",method:"POST",data:c,success:function(){console.log("Save successful")},error:function(){console.log("There was an error")}})}function m(a){return function(b){u.val(b.replace(/^#(.)\1(.)\2(.)\3$/,"#$1$2$3")),a.color(b),u.css({background:b,color:Raphael.rgb2hsb(b).b<.5?"#FFF":"#000"})}}function n(a){var b=t.rect(200,200,200,200),c=u.val();a.preventDefault(),b.attr({fill:c,cursor:"move",stroke:"#FFF","stroke-width":10}),b._type="color",b._hex=c,j(b),w.hide(),p.color("#eee"),u.css({background:"#FFF",color:"#000"}),u.val("#eee")}var o,p,q=$("#canvas"),r=1240,s=960,t=Raphael(q[0],s,r),u=$("#colorHex"),v=$("#imageUrl"),w=$("#pickerContainer"),x=($("#pickerCanvas"),[]),y=null;t.canvas.style.backgroundColor="#f2f2f2",o=document.getElementById("canvas").getAttribute("data-key"),$(t.canvas).click(function(){e(y)}),w.hide(),$("#addColorButton").click(n),$("#moveBackButton").click(h),$("#moveForwardButton").click(i),$("#addImageButton").click(function(a){a.preventDefault(),$.ajax({url:"/api/image/upload?board="+o+"&type=url&url="+v.val(),method:"GET",success:k,error:function(){console.log("There was an error")}})}),$("#imageUpload").on("submit",function(a){a.preventDefault(),$(this).ajaxForm({url:"/api/image/upload?board="+o+"&type=upload",method:"POST",success:k,error:function(){console.log("There was an error")}})}),$("#addColor").click(function(a){a.preventDefault(),p||(p=Raphael.colorpicker(0,0,$("#left-nav").innerWidth()-1,"#EEE",document.getElementById("pickerCanvas")),p.onchange=m(p),p.color("#eee"),u.val("#eee")),w.show()}),$("#selectColor").click(n),u.keyup(function(){p&&colorWheel.color(u.val())}),$("#saveButton").click(l)}(jQuery,Raphael);