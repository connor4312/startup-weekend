/*! Built 13-10-2013 at #SWPNS */
$(function(){function a(){this.ox=this.attr("x"),this.oy=this.attr("y")}function b(a,b){var c=this.ox+a,d=this.oy+b;c=Math.min(u-this.attr("width")-10,c),c=Math.max(10,c),d=Math.min(t-this.attr("height")-10,d),d=Math.max(10,d),this.attr({x:c,y:d}),this._moving=!0,this._glow&&(this._glow.remove(),this._glow=void 0)}function c(){d(this,this.selected)}function d(a,b){a._glow&&a._glow.remove(),a._glow=a.glow({color:b?"#21a3c9":"#000000"})}function e(a){a&&(a.selected=!1,d(a,!1),B=null)}function f(a){a.selected=!0,d(a,!0),B=a}function g(a){var b=B._index,c=A.splice(a?b+1:b-1,1)[0];B._index=a?B._index+1:B._index-1,c._index=a?c._index-1:c._index+1,B[a?"insertAfter":"insertBefore"](c),A.splice(c._index,0,c),d(B,B.selected)}function h(a){a.preventDefault(),A.length<2||!B||0===B._index||g(!1)}function i(){event.preventDefault(),A.length<2||!B||B._index===A.length-1||g(!0)}function j(d){d._index=A.length,d.click(function(a){a.stopPropagation(),this!==B||this._moving||e(this),this._moving&&(this._moving=!1)}),d.dblclick(function(a){a.stopPropagation(),e(B),f(this)}),d._glow=d.glow(),d.drag(b,a,c),A.push(d),console.log(d,d.attr("x"),d.attr("y"))}function k(a){var b,c,d,e,f=a.data||a,g=0;for("[object Array]"!==Object.prototype.toString.call(f)&&(f=[f]);b=f[g++];)d=parseInt(b.x)||200,e=parseInt(b.y)||200,c=v.rect(d,e,b.width,b.height),c.attr({x:d,y:e,cursor:"move",stroke:"#FFF","stroke-width":10,fill:"url("+unescape(b.url)+")"}),c._type="image",c._width=b.width,c._height=b.height,c._url=b.url,j(c);$("#image").modal("hide"),$("#imageupload").modal("hide"),$("#dribbble").modal("hide"),$("#pinterest").modal("hide"),$("#addImageButton").attr("disabled",!1),$("#imageUploadButton").attr("disabled",!1),$("#js-dribbble-bucket-sub").attr("disabled",!1),$("#js-pin-sub").attr("disabled",!1),x.val("")}function l(a){var b,c={board:q},d=0,e=[];for(a.preventDefault();b=A[d++];)e.push({type:b._type,x:b.attr("x"),y:b.attr("y"),width:b._width||null,height:b._height||null,url:b._url||null,index:b._index,color:b._hex||null});c.elements=e,$.ajax({url:"/api",method:"POST",data:c,success:function(){console.log("Save successful")},error:function(){console.log("There was an error")}})}function m(a){return function(b){w.val(b.replace(/^#(.)\1(.)\2(.)\3$/,"#$1$2$3")),a.color(b),w.css({background:b,color:Raphael.rgb2hsb(b).b<.5?"#FFF":"#000"})}}function n(a){var b=parseInt(a.y)||200,c=parseInt(a.x)||200,d=a.color||w.val(),e=v.rect(c,b,200,200);e.attr({x:c,y:b,fill:d,cursor:"move",stroke:"#FFF","stroke-width":10}),e._type="color",e._hex=d,j(e),y.hide(),r&&(r.color("#eee"),w.css({background:"#FFF",color:"#000"}),w.val("#eee"))}function o(a){for(var b,c=0;b=a[c++];)"color"===b.type?n(b):k(b)}function p(a,b){$.ajax({url:"/api/image/upload?board="+q+"&type="+b+"&url="+a,method:"GET",success:k,error:function(){console.log("There was an error")}})}var q,r,s=$("#canvas"),t=1240,u=960,v=Raphael(s[0],u,t),w=$("#colorHex"),x=$("#imageUrl"),y=$("#pickerContainer"),z=$("#pickerCanvas"),A=[],B=null,C=$("#js-dribbble-bucket-in"),D=$("#js-pin-in");v.canvas.style.backgroundColor="#f2f2f2",q=document.getElementById("canvas").getAttribute("data-key"),$(v.canvas).click(function(){e(B)}),y.hide(),$("#addColorButton").click(function(a){a.preventDefault(),n()}),$("#moveBackButton").click(h),$("#moveForwardButton").click(i),$("#addImageButton").click(function(a){a.preventDefault(),p(x.val(),"url"),$(this).attr("disabled",!0)}),$("#imageUpload").ajaxForm(k),$("#imageUploadButton").click(function(){setTimeout($(this).attr("disabled",!0),100)}),$("#addColor").click(function(a){var b=$("#left-nav").innerWidth()-1,c=z.position();a.preventDefault(),r||(r=Raphael.colorpicker(c.left-b,c.top-b,b,"#EEE",z[0]),r.onchange=m(r),r.color("#eee"),w.val("#eee")),y.show()}),$("#selectColor").click(n),w.keyup(function(){r&&colorWheel.color(w.val())}),$("#saveButton").click(l),$("#js-dribbble-bucket-sub").click(function(a){a.preventDefault(),p(C.val(),"dribbbleBucket"),$(this).attr("disabled",!0)}),$("#js-pin-sub").click(function(a){a.preventDefault(),p(D.val(),"pinterest"),$(this).attr("disabled",!0)}),$.ajax({url:"/api?board="+q,method:"GET",success:function(a){var b=a.data;b.length&&o(b)}})});