/*! Built 13-10-2013 at #SWPNS */
$(function(){function a(){this.ox=this.attr("x"),this.oy=this.attr("y")}function b(a,b){var c=this.ox+a,d=this.oy+b;c=Math.min(t-this.attr("width")-10,c),c=Math.max(10,c),d=Math.min(s-this.attr("height")-10,d),d=Math.max(10,d),this.attr({x:c,y:d}),this._moving=!0,this._glow&&(this._glow.remove(),this._glow=void 0)}function c(){d(this,this.selected)}function d(a,b){a._glow&&a._glow.remove(),a._glow=a.glow({color:b?"#21a3c9":"#000000"})}function e(a){a&&(a.selected=!1,d(a,!1),z=null)}function f(a){a.selected=!0,d(a,!0),z=a}function g(a){var b=z._index,c=y.splice(a?b+1:b-1,1)[0];z._index=a?z._index+1:z._index-1,c._index=a?c._index-1:c._index+1,z[a?"insertAfter":"insertBefore"](c),y.splice(c._index,0,c),d(z,z.selected)}function h(a){a.preventDefault(),y.length<2||!z||0===z._index||g(!1)}function i(){event.preventDefault(),y.length<2||!z||z._index===y.length-1||g(!0)}function j(d){d._index=y.length,d.click(function(a){a.stopPropagation(),this!==z||this._moving||e(this),this._moving&&(this._moving=!1)}),d.dblclick(function(a){a.stopPropagation(),e(z),f(this)}),d._glow=d.glow(),d.drag(b,a,c),y.push(d)}function k(a){var b=a.data?a.data[0]:a,c=u.rect(b.x||200,b.y||200,b.width,b.height);c.attr({cursor:"move",stroke:"#FFF","stroke-width":10,fill:"url("+unescape(b.url)+")"}),c._type="image",c._width=b.width,c._height=b.height,c._url=b.url,j(c),$("#image").modal("hide"),$("#imageupload").modal("hide"),w.val("")}function l(a){var b,c={board:p},d=0,e=[];for(a.preventDefault();b=y[d++];)e.push({type:b._type,x:b.attr("x"),y:b.attr("y"),width:b._width||null,height:b._height||null,url:b._url||null,index:b._index,color:b._hex||null});c.elements=e,$.ajax({url:"/api",method:"POST",data:c,success:function(){console.log("Save successful")},error:function(){console.log("There was an error")}})}function m(a){return function(b){v.val(b.replace(/^#(.)\1(.)\2(.)\3$/,"#$1$2$3")),a.color(b),v.css({background:b,color:Raphael.rgb2hsb(b).b<.5?"#FFF":"#000"})}}function n(a){var b=a.y||200,c=a.x||200,d=a.color||v.val(),e=u.rect(c,b,200,200);e.attr({fill:d,cursor:"move",stroke:"#FFF","stroke-width":10}),e._type="color",e._hex=d,j(e),x.hide(),q.color("#eee"),v.css({background:"#FFF",color:"#000"}),v.val("#eee")}function o(a){for(var b,c=0;b=a[c++];)"color"===b.type?n(b):k(b)}var p,q,r=$("#canvas"),s=1240,t=960,u=Raphael(r[0],t,s),v=$("#colorHex"),w=$("#imageUrl"),x=$("#pickerContainer"),y=($("#pickerCanvas"),[]),z=null;u.canvas.style.backgroundColor="#f2f2f2",p=document.getElementById("canvas").getAttribute("data-key"),$(u.canvas).click(function(){e(z)}),x.hide(),$("#addColorButton").click(function(a){a.preventDefault(),n()}),$("#moveBackButton").click(h),$("#moveForwardButton").click(i),$("#addImageButton").click(function(a){a.preventDefault(),$.ajax({url:"/api/image/upload?board="+p+"&type=url&url="+w.val(),method:"GET",success:k,error:function(){console.log("There was an error")}})}),$("#imageUpload").ajaxForm(k),$("#imageUploadButton").click(function(){this.disabled=!0}),$("#addColor").click(function(a){a.preventDefault(),q||(q=Raphael.colorpicker(0,0,$("#left-nav").innerWidth()-1,"#EEE",document.getElementById("pickerCanvas")),q.onchange=m(q),q.color("#eee"),v.val("#eee")),x.show()}),$("#selectColor").click(n),v.keyup(function(){q&&colorWheel.color(v.val())}),$("#saveButton").click(l),$.ajax({url:"/api?board="+p,method:"GET",success:function(a){var b=a.data;b.length&&o(b)}})});